<script>
    const BIN_ID = "69939c421a35bc0895802a0e"; 
    const API_KEY = "$2a$10$UjMBcBnIIYxfPNVocHLdNeQyJq3vLbmSzG6zbPclsESfUzGHOgKqG";
    const PASSWORD = "admin123$"; 
    let salesData = [];
    let editingId = null;

    setNow();

    document.querySelectorAll('.add-form input, .add-form select').forEach(el => {
        el.addEventListener('focus', () => document.getElementById('addForm').classList.add('locked'));
        el.addEventListener('click', () => document.getElementById('addForm').classList.add('locked'));
    });

    function setNow() {
        const now = new Date();
        document.getElementById('datePart').value = now.toISOString().split('T')[0];
        document.getElementById('timePart').value = now.toTimeString().split(' ')[0];
    }
    
    document.getElementById('productInput').addEventListener('change', function() {
      if(this.value === "Digital Basics") document.getElementById('priceInput').value = 250;
      if(this.value === "Full Stack Dev") document.getElementById('priceInput').value = 300;
    });

    function login() {
      if (document.getElementById('adminPass').value === PASSWORD) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadData();
      } else { 
        document.getElementById('loginError').style.display = 'block'; 
      }
    }

    async function loadData() {
      showLoader(true);
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { 
            headers: { 'X-Master-Key': API_KEY } 
        });
        
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`JSONBin –æ—Ç–¥–∞–ª –æ—à–∏–±–∫—É ${res.status} –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ${errText}`);
        }

        const d = await res.json();
        
        // –ù–∞–¥–µ–∂–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        if (Array.isArray(d.record)) {
            salesData = d.record;
        } else if (d.record && Array.isArray(d.record.customers)) {
            salesData = d.record.customers; 
        } else {
            salesData = [];
        }
        
        renderTable();
      } catch (e) { 
        alert("–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò: " + e.message); 
      }
      showLoader(false);
    }

    async function handleFormSubmit() {
      const name = document.getElementById('nameInput').value;
      const email = document.getElementById('emailInput').value;
      const txnId = document.getElementById('txnInput').value; 
      const price = parseFloat(document.getElementById('priceInput').value);
      
      const dateVal = document.getElementById('datePart').value;
      const timeVal = document.getElementById('timePart').value;
      
      if (!email || !price || !dateVal || !timeVal) {
          alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è (Email, Price, Date, Time)!");
          return;
      }

      showLoader(true);
      const fullDateTime = `${dateVal} ${timeVal}`;

      const record = { 
          id: editingId || Date.now(), 
          date: fullDateTime,
          rawDate: dateVal,
          rawTime: timeVal,
          name: name,
          email: email, 
          txnId: txnId, 
          product: document.getElementById('productInput').value, 
          price: price 
      };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è
      const backupData = [...salesData];

      if (editingId) { 
          const i = salesData.findIndex(s => s.id === editingId); 
          if(i !== -1) salesData[i] = record; 
      } else { 
          salesData.push(record); 
      }

      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
          method: 'PUT', 
          headers: { 
              'Content-Type': 'application/json', 
              'X-Master-Key': API_KEY 
          },
          body: JSON.stringify(salesData)
        });
        
        // –í–û–¢ –ó–î–ï–°–¨ –ú–´ –õ–û–í–ò–ú –†–ï–ê–õ–¨–ù–£–Æ –û–®–ò–ë–ö–£ –û–ë–õ–ê–ö–ê
        if (!response.ok) {
            const errorDetails = await response.text();
            throw new Error(`–ö–æ–¥: ${response.status}. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${errorDetails}`);
        }
        
        // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
        document.getElementById('addForm').classList.remove('locked');
        editingId = null; 
        document.getElementById('nameInput').value = "";
        document.getElementById('emailInput').value = ""; 
        document.getElementById('txnInput').value = ""; 
        document.getElementById('submitBtn').innerText = "+ Sync"; 
        setNow(); 
        renderTable();

      } catch (e) { 
        // –ï—Å–ª–∏ –æ–±–ª–∞–∫–æ –æ—Ç–∫–ª–æ–Ω–∏–ª–æ –∑–∞–ø—Ä–æ—Å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–∑–∞–¥, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ
        salesData = backupData;
        alert("–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –í –û–ë–õ–ê–ö–û!\n\n" + e.message + "\n\n–°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç —ç—Ç–æ–π –æ—à–∏–±–∫–∏ –∏ –ø–æ–∫–∞–∂–∏ –º–Ω–µ."); 
      }
      
      showLoader(false);
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = "";
      let total = 0;
      
      salesData.sort((a,b) => b.id - a.id).forEach(sale => {
        total += sale.price;
        const displayDate = sale.date ? sale.date : "Old Record"; 
        const displayName = sale.name ? `<strong style="color:white;">${sale.name}</strong>` : `<span style="color:#475569">-</span>`;
        const displayTxn = sale.txnId ? `<span style="font-family:monospace; color:#94a3b8; font-size:0.85rem;">${sale.txnId}</span>` : `<span style="color:#475569">None</span>`;

        tbody.innerHTML += `
          <tr>
            <td style="font-family: monospace; font-size: 0.9rem; color:var(--muted);">${displayDate}</td>
            <td>${displayName}</td>
            <td>${sale.email}</td>
            <td>${displayTxn}</td>
            <td>${sale.product}</td>
            <td style="font-weight:bold; color:var(--accent);">‚Ç¨${sale.price}</td>
            <td><span class="badge-paid">Paid</span></td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon btn-edit" onclick="editSale(${sale.id})">‚úèÔ∏è</button>
                <button class="btn-icon btn-delete" onclick="deleteSale(${sale.id})">üóëÔ∏è</button>
              </div>
            </td>
          </tr>`;
      });
      document.getElementById('totalRevenue').innerText = `‚Ç¨${total}`;
      document.getElementById('totalSales').innerText = salesData.length;
    }

    function editSale(id) {
      const item = salesData.find(s => s.id === id);
      if(!item) return;
      
      if (item.rawDate && item.rawTime) {
          document.getElementById('datePart').value = item.rawDate;
          document.getElementById('timePart').value = item.rawTime;
      } else if (item.date) {
          const parts = item.date.split(' ');
          if (parts.length >= 2) {
             document.getElementById('datePart').value = parts[0];
             document.getElementById('timePart').value = parts[1];
          }
      }

      document.getElementById('nameInput').value = item.name || "";
      document.getElementById('emailInput').value = item.email;
      document.getElementById('txnInput').value = item.txnId || ""; 
      document.getElementById('productInput').value = item.product;
      document.getElementById('priceInput').value = item.price;
      
      editingId = id; 
      document.getElementById('submitBtn').innerText = "üíæ Save"; 
      
      const form = document.getElementById('addForm');
      form.classList.add('locked');
      window.scrollTo(0,0);
    }

    async function deleteSale(id) {
      if(!confirm("Delete?")) return;
      showLoader(true);
      
      const backupData = [...salesData];
      salesData = salesData.filter(s => s.id !== id);
      
      try {
          const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
            body: JSON.stringify(salesData)
          });
          
          if (!response.ok) {
              const errorDetails = await response.text();
              throw new Error(`–ö–æ–¥: ${response.status}. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${errorDetails}`);
          }

          if (editingId === id) { 
              editingId = null;
              document.getElementById('submitBtn').innerText = "+ Sync";
              document.getElementById('nameInput').value = "";
              document.getElementById('emailInput').value = "";
              document.getElementById('txnInput').value = "";
              document.getElementById('addForm').classList.remove('locked');
              setNow();
          }
          renderTable();
      } catch(e) {
          salesData = backupData; // –û—Ç–∫–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª
          alert("–û–®–ò–ë–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –í –û–ë–õ–ê–ö–ï!\n\n" + e.message);
      }
      
      showLoader(false);
    }

    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
  </script>
